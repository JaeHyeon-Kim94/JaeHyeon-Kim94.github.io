---
categories: [linux]
tags: [linux]
---

# 커널과 모듈

<br/>

## 커널의 구조와 기능

컴퓨터는 크게 **하드웨어(HW)**와 **소프트웨어(SW)**로 나뉘고, SW는 다시 **운영체제**와 **응용 프로그램**으로 나뉜다.  

그리고 운영체제는 **커널**과 **시스템 프로그램**으로 구분되는데, 사용자와의 직접적인 상호작용은 시스템 프로그램을 통해서 이루어지며 커널은 `컴퓨터 자원들을 관리하는 운영체제의 핵심 부분`이다.  

컴퓨터 자원은 **물리적인 하드웨어 자원**과 **추상화된 자원**을 의미하는 것으로, 자원을 추상화한다는 것은 물리적으로 하나 뿐인 하드웨어를 여러 사용자들이 번갈아 사용하게 중재함으로서, 마치 한 개의 하드웨어가 여러개인 것 처럼 보여지도록 하는 것을 의미한다. <br/>

- **커널이 추상화하여 관리하는 물리적 자원(A)**들과 **이를 추상화한 자원을 칭하는 용어(B)**

A | B
--- | ---
CPU | 태스크(task)
메모리 | 페이지(page), 세그먼트(segment)
디스크 | 파일(file)
네트워크 | 소켓(socket)

이 외에 외부 장치(프린터, 키보드 등)가 있다.

결론적으로 커널은 `하드웨어 자원을 관리`하는 역할을 하며, 커널의 구성요소들은 각각 특정 하드웨어 자원을 관리하는 관리자로, 다음과 같다.
- **Task Manager** : 프로세스 생성 및 소멸 담당. 프로세스 스케줄러로 여러 프로세스가 동작할 수 있도록 각 프로세스 생성 및 제거
- **Memory Manager** : 시스템 메모리 하드웨어의 효율적 관리. 각각의 프로세스가 독립적 공간에서 수행할 수 있도록 **가상 메모리 주소**를 제공하여 이 가상 메모리를 관리.
- **File System Manager** : 시스템에 동작하는 **모든 자원을 파일처럼 다룰 수 있도록 인터페이스를 제공**
- **Network Manager** : 응용 프로그램과 네트워크 디바이스 드라이버를 연결
- **Device Driver** : 입출력 장치 관리, 인터럽트 요청 및 처리 등 기능 수행

<br/>

![리눅스 커널의 기능과 구조](../../assets/img/linux_kernel.png)


커널 구성요소들이 존재하는 공간인 Kernel Space,
태스크(Process)가 돌아가는 공간인 User Space,
Hardware 세 영역으로 나뉘는데, 

1. C/C++과 같은 컴퓨팅 언어로 작성된 프로그램 파일이 메모리상에 적재되어 실행되면 task가 되고,  
2. 이 task에서 커널이 관리하는 자원(하드웨어)에 접근할 필요가 있을 경우 System Call Interface를 통해 Kernel Space의 자원 관리자에게 요청이 전달된다.
3. 그리고 커널의 자원 관리자는 사용자 요청에 맞는 하드웨어에 사용자 명령을 전달하고 작업을 수행한다.



## 커널과 모듈  

위에 설명한 것처럼, 커널은 하드웨어 자원을 관리/지원하는 역할을 수행한다. 초창기 커널의 경우 지원할 하드웨어 자원이 많지 않았으므로 문제가 없었으나, **시간이 지날수록 지원해야 할 하드웨어가 많아짐에 따라 커널에도 들어가야 할 코드가 많아지게 되었다.** 이렇게 되면 운영체제가 무거워지는 결과를 낳게 되는데, 항상 필요한 부분이 아니라 가끔씩 필요할 때에만 사용하는 경우에는 별도로 보관하다가 필요시 호출하는 방식으로 분리하게 되었다. 이렇게 별도로 보관되는 것을 `모듈`이라고 한다.

![](../../assets/img/linux_modules_kenel.png)

이렇게 분리하거나 커널에 넣어두는 기존 커널이 사용자 입장에서 적절하지 않을 수 있다. 각각이 필요한 기능, 필요하지 않은 기능들이 다를 것이기 때문에 커널에 포함될 것과 모듈로 분리할 것을 사용자가 원하는 대로 지정하여 다시 컴파일하게 되면 같은 하드웨어라도 더 효율적인 성능을 발휘할 수 있게 된다.


## 커널 컴파일  

> 추가적 학습 필요

CentOS 8 기준

 - 커널 : /boot/vmlinuz* 파일
 - 모듈 : /lib/modules/{version}/ 디렉터리

```bash
#1. 관련 패키지 설치
$ dnf -y install make bison flex elfutils-libelf-devel openssl-devel gcc gcc-c++

#2. 현재 디렉터리 확인(unpack된 커널 소스 파일이 있는 디렉터리)
$ pwd 

#3. 커널 설정 초기화
$ make mrproper

#4. 커널 환경 설정
$ make xconfig

#5. 설정 파일 편집
$ vi .config # ==> CONFIG_SYSTEM_TRUSTED_KEYRING, CONFIG_SYSTEM_TRUSTED_KEYS 주석처리

#6. 컴파일
#6.1. 이전 컴파일 정보 삭제
$ make clean

#6.2. 컴파일
$ make; make moduels_install; make install

# 7. 결과 확인
$ ls -l /lib/modules
$ ls -l /boot
```


## REFERENCES

[커널의 개념과 커널의 구조](https://5equal0.tistory.com/entry/Linux-Kernel-%EC%BB%A4%EB%84%90%EC%9D%98-%EA%B0%9C%EB%85%90%EA%B3%BC-%EC%BB%A4%EB%84%90%EC%9D%98-%EA%B5%AC%EC%A1%B0)

[리눅스 커널과 디바이스 드라이버](https://cheonee.tistory.com/entry/%EB%A6%AC%EB%88%85%EC%8A%A4-%EC%BB%A4%EB%84%90%EA%B3%BC-%EB%94%94%EB%B0%94%EC%9D%B4%EC%8A%A4-%EB%93%9C%EB%9D%BC%EC%9D%B4%EB%B2%84)

[이것이 리눅스다 with RedHat CentOS 8](http://www.yes24.com/Product/Goods/89769181)