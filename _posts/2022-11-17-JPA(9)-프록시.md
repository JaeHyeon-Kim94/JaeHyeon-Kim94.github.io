---
title : JPA(9) - 프록시
categories : [jpa]
tags: [jpa, hibernate]
published : false
---

- 프록시와 즉시로딩/지연로딩
  - 지연로딩 : 엔티티가 실제 사용될 때까지 데이터베이스 조회를 지연하는 것.
  - 프록시 : 지연로딩을 사용하려면 실제 엔티티 객체 대신에 데이터베이스 조회를 지연할 수 있는 가짜 객체가 필요한데, 이를 프록시 객체라고 한다.
    - JPA는 지연 로딩에 대한 구현을 구현체에 위임했고, 앞으로의 내용은 hibernate 구현체에 대한 내용임.
      - hibernate는 지연 로딩 지원을 위한 방법으로 1) 프록시, 2) 바이트코드 수정 두 가지 방법을 제공.


 - em.find를 통해 엔티티를 직접 조회하게 되면 **실제 사용 여부와 무관하게 데이터베이스에서 조회**한다. 따라서 사용 시점까지 지연이 필요하면 **em.getReference()** 메서드를 사용하면 된다.
   - 이 메서드를 호출하면 JPA는 DB를 조회하거나 엔티티 객체를 생성하지 않고 **DB 접근을 위한 프록시 객체를 반환**한다.

   - 프록시는 실제 객체를 상속받아 만들어지기 때문에 실제 클래스와 겉 모양이 같고, 따라서 사용하는 입장에서는 실제 객체인지 프록시 객체인지 구분하지 않고 사용해도 된다.
   - 프록시 객체는 실제 객체에 대한 참조를 보관한다. 그리고 프록시 객체의 메서드를 호출하면 프록시 객체는 실제 객체의 메서드를 호출한다. 이처럼 실제 사용될 때 프록시 객체는 실제 엔티티 객체를 생성하는데 이를 **프록시 객체의 초기화**라 한다.
     - ex) 1) getName() -> 2) 초기화 요청 to 영속성 컨텍스트 -> 3) DB 조회 -> 4) 실제 엔티티 생성 및 참조 보관

 - 프록시의 특징
   - 처음 사용할 떄 한 번만 초기화 된다.
   - 프록시 객체가 초기화된다고 해서 프록시 객체가 실제 객체가 되는 것은 아니고, 프록시 객체를 통해 실제 엔티티에 접근할 수 있게 된다.
   - 실제 객체를 상속받은 객체이기 때문에 타입 체크시에 주의해서 사용해야 한다.
   - 영속성 컨텍스트에 찾는 실제 객체가 있으면 DB조회의 필요가 없으므로 getReference()를 호출해도 프록시가 아닌 실제 엔티티를 반환한다.
   - 초기화는 영속성 컨텍스트를 통해 이루어지므로 영속상태가 아닌 준영속상태의 프록시를 초기화하면 문제가 발생한다.(LazyinitilaizationException)

 - getReference시 식별자가 전달되고, 프록시는 이 식별자를 보관하고 있다가 실제 엔티티를 조회할 때 사용한다.
   - getId할 경우 엔티티 접근 방식이 PROPERTY 방식인 경우는 프록시를 초기화하지 않고, FIELD 방식인 경우 getId() 메서드가 id만 조회하는지 내부를 알 수 없으므로 프록시 객체를 초기화 한다.




- 영속성 전이와 고아 객체
